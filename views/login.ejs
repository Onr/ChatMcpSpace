<div class="min-h-screen flex items-center justify-center px-4">
  <div class="max-w-md w-full space-y-8">
    <div>
      <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
        Sign in to your account
      </h2>
      <p class="mt-2 text-center text-sm text-gray-600">
        Don't have an account?
        <a href="/register" class="font-medium text-blue-600 hover:text-blue-500">
          Create one now
        </a>
      </p>
    </div>
    
    <% if (error) { %>
    <div class="bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded relative" role="alert">
      <span class="block sm:inline"><%= error %></span>
    </div>
    <% } %>
    
    <form class="mt-8 space-y-6" action="/login" method="POST" id="loginForm">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="rounded-md shadow-sm space-y-4">
        <div>
          <label for="email" class="block text-sm font-medium text-gray-700">Email address</label>
          <input 
            id="email" 
            name="email" 
            type="email" 
            required 
            class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
            placeholder="you@example.com"
            value="<%= email || '' %>"
          >
        </div>
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
          <input 
            id="password" 
            name="password" 
            type="password" 
            required 
            class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm"
            placeholder="••••••••"
          >
        </div>
      </div>

      <div>
        <button 
          type="submit" 
          class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          Sign In
        </button>
      </div>
    </form>
  </div>
</div>

<script>
(function() {
  const form = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const submitButton = form.querySelector('button[type="submit"]');
  const originalButtonText = submitButton.textContent;

  // Clear any stale encryption artifacts when hitting the login page
  try {
    sessionStorage.removeItem('pendingEncryptionPassword');
    sessionStorage.removeItem('encryptionKey');
  } catch (err) {
    console.warn('Unable to clear stored encryption state', err);
  }

  // Helper function to start countdown on the button
  function startButtonCountdown(seconds) {
    submitButton.disabled = true;
    submitButton.classList.add('opacity-50', 'cursor-not-allowed');
    submitButton.classList.remove('hover:bg-blue-700');
    
    let remaining = seconds;
    submitButton.textContent = `Wait ${remaining}s`;
    
    const interval = setInterval(() => {
      remaining--;
      if (remaining <= 0) {
        clearInterval(interval);
        submitButton.textContent = originalButtonText;
        submitButton.disabled = false;
        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
        submitButton.classList.add('hover:bg-blue-700');
      } else {
        submitButton.textContent = `Wait ${remaining}s`;
      }
    }, 1000);
  }

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const email = emailInput.value;
    const password = passwordInput.value;
    
    if (!email || !email.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }
    
    if (!password) {
      alert('Please enter your password');
      return;
    }

    // Cache password for post-login decryption key derivation (cleared after use)
    try {
      sessionStorage.setItem('pendingEncryptionPassword', password);
    } catch (err) {
      console.warn('Unable to cache password for encryption setup', err);
    }

    submitButton.textContent = 'Signing in...';
    submitButton.disabled = true;

    try {
      const formData = new FormData(form);
      const data = new URLSearchParams(formData);
      
      const response = await fetch(form.action, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: data,
        redirect: 'follow'
      });
      
      // Check if rate limited
      if (response.status === 429) {
        const result = await response.json();
        const retryAfter = result.error?.retryAfter || 30;
        startButtonCountdown(retryAfter);
        return;
      }
      
      // If redirected, follow it
      if (response.redirected) {
        window.location.href = response.url;
        return;
      }
      
      // Check if response is HTML (success or error page)
      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('text/html')) {
        const html = await response.text();
        document.open();
        document.write(html);
        document.close();
        return;
      }
    } catch (error) {
      console.error('Form submission error:', error);
      submitButton.textContent = originalButtonText;
      submitButton.disabled = false;
    }
  });
})();
</script>
